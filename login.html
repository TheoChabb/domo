<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="styles/style1.css">
</head>
<body>
  <div class="div_formulaire">
    <h2>Connexion</h2>
    <div id="error-message" class="erreur"></div>
    <label for="email">Adresse email :</label>
    <input type="email" id="email" placeholder="Email">
    <br>
    <label for="password">Mot de passe :</label>
    <input type="password" id="password" placeholder="Mot de passe">
    <button id="loginBtn">Se connecter</button>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init('TsfbNCBs576Ka422a'); // ton public key
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    // Fonction utilitaire pour transformer une erreur Firebase en message utilisateur
    function handleAuthError(error) {
      console.error("Firebase Auth error:", error);
      let code = "";
      if (error && error.code) {
        const parts = String(error.code).split("/");
        code = parts.length > 1 ? parts[1] : parts[0];
        code = code.replace(/[^a-z0-9\-]/ig, "").toLowerCase();
      }

      const messages = {
        "invalid-email": "Adresse e-mail invalide.",
        "missing-email": "Adresse e-mail manquante.",
        "user-disabled": "Ce compte a Ã©tÃ© dÃ©sactivÃ©.",
        "user-not-found": "Aucun utilisateur trouvÃ© avec cet e-mail.",
        "wrong-password": "Mot de passe incorrect.",
        "too-many-requests": "Trop de tentatives. RÃ©essaie plus tard.",
        "network-request-failed": "ProblÃ¨me rÃ©seau â€” vÃ©rifie ta connexion.",
        "invalid-credential": "Identifiants invalides.",
        "operation-not-allowed": "MÃ©thode d'authentification dÃ©sactivÃ©e (voir Firebase).",
        "internal-error": "Erreur interne. RÃ©essaie plus tard.",
        "email-already-in-use": "Cet e-mail est dÃ©jÃ  utilisÃ©.",
        "weak-password": "Mot de passe trop faible (min 6 caractÃ¨res)."
      };

      return messages[code] || (error && error.message) || "Erreur inconnue, consulte la console.";
    }

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC9npt7PuRmlNUcPSFQbhQL5lkT3rejNKQ",
      authDomain: "securisation-domotique.firebaseapp.com",
      projectId: "securisation-domotique",
      storageBucket: "securisation-domotique.appspot.com",
      messagingSenderId: "493865233555",
      appId: "1:493865233555:web:25f2adb612c3b98da9b166",
      measurementId: "G-F4KHR48KZR"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Fonction pour rÃ©cupÃ©rer IP publique
    async function getPublicIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch (e) {
        return "IP inconnue";
      }
    }

    // Fonction d'envoi d'email via EmailJS (sans formulaire)
    async function sendMail(title, name, message, email) {
      const serviceID = "default_service";
      const templateID = "template_r2fhmko";

      const ip = await getPublicIP();
      const deviceInfo = `
      Navigateur/OS : ${navigator.userAgent}
      Plateforme : ${navigator.platform}
      Langue : ${navigator.language}
      RÃ©solution Ã©cran : ${screen.width}x${screen.height}
      Fuseau horaire : ${Intl.DateTimeFormat().resolvedOptions().timeZone}
      IP publique : ${ip}
      `;

      const params = { 
        title, 
        name, 
        message: message + "\n\n--- Infos appareil ---\n" + deviceInfo, 
        email 
      };

      emailjs.send(serviceID, templateID, params)
        .then(() => console.log("ðŸ“§ Mail envoyÃ©"))
        .catch(err => console.error("Erreur envoi mail:", err));
    }

    // Fonction login
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = "";

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          window.location.href = "index.html";
        })
        .catch(error => {
          if (errorDiv) {
            errorDiv.textContent = handleAuthError(error);
          }

          // Si mot de passe erronÃ© ou credentials invalides â†’ envoi d'un mail
          if (error && (error.code.indexOf("wrong-password") !== -1 || error.code.indexOf("invalid-credential") !== -1)) {
            sendMail(
              "Tentative de connexion Ã©chouÃ©e",
              "domo@contact.fr",
              "Une tentative de connexion a Ã©chouÃ© avec l'email : " + email,
              email
            );
          }
        });
    }

    // Redirection si dÃ©jÃ  connectÃ©
    auth.onAuthStateChanged(user => {
      if (user) {
        window.location.href = "index.html";
      }
    });

    document.getElementById("loginBtn").addEventListener("click", login);
  </script>
</body>
</html>
