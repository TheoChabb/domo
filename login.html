<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="styles/style1.css">
</head>
<body>
  <div class="div_formulaire">
    <h2>Connexion</h2>
    <div id="error-message" class="erreur"></div>
    <label for="email">Adresse email :</label>
    <input type="email" id="email" placeholder="Email">
    <br>
    <label for="password">Mot de passe :</label>
    <input type="password" id="password" placeholder="Mot de passe">
    <button id="loginBtn">Se connecter</button>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init('TsfbNCBs576Ka422a'); // cl√© publique EmailJS
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    // ----- Config Firebase -----
    const firebaseConfig = {
      apiKey: "AIzaSyC9npt7PuRmlNUcPSFQbhQL5lkT3rejNKQ",
      authDomain: "securisation-domotique.firebaseapp.com",
      projectId: "securisation-domotique",
      storageBucket: "securisation-domotique.appspot.com",
      messagingSenderId: "493865233555",
      appId: "1:493865233555:web:25f2adb612c3b98da9b166",
      measurementId: "G-F4KHR48KZR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ----- Helpers : IP, geoIP, geo navigateur -----
    async function getPublicIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip || "IP inconnue";
      } catch (e) {
        return "IP inconnue";
      }
    }

    async function getGeoFromIP(ip) {
      try {
        // ipapi.co fournit ville/region/pays en JSON
        const res = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await res.json();
        if (data && !data.error) {
          const city = data.city || "‚Äî";
          const region = data.region || "‚Äî";
          const country = data.country_name || "‚Äî";
          return `${city}, ${region}, ${country}`;
        }
        return "Localisation IP inconnue";
      } catch (e) {
        return "Localisation IP inconnue";
      }
    }

    function getBrowserLocation(timeoutMs = 8000) {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve("GPS non disponible");
          return;
        }
        let handled = false;
        const timer = setTimeout(() => {
          if (!handled) {
            handled = true;
            resolve("Permission GPS expir√©e ou lente");
          }
        }, timeoutMs);

        navigator.geolocation.getCurrentPosition(
          pos => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            resolve(`GPS: ${pos.coords.latitude}, ${pos.coords.longitude} (pr√©cision ${pos.coords.accuracy}m)`);
          },
          err => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            if (err.code === 1) resolve("Permission GPS refus√©e");
            else resolve("Erreur r√©cup√©ration GPS");
          },
          { enableHighAccuracy: false, maximumAge: 60_000, timeout: timeoutMs }
        );
      });
    }

    // ----- Compose device info -----
    async function collectDeviceInfo() {
      const ip = await getPublicIP();
      const geoIP = await getGeoFromIP(ip);
      const geoBrowser = await getBrowserLocation();
      const info = {
        userAgent: navigator.userAgent || "‚Äî",
        platform: navigator.platform || "‚Äî",
        language: navigator.language || "‚Äî",
        resolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "‚Äî",
        ip,
        geoIP,
        geoBrowser
      };

      // format texte lisible
      const deviceText = 
`Navigateur/OS : ${info.userAgent}
Plateforme : ${info.platform}
Langue : ${info.language}
R√©solution √©cran : ${info.resolution}
Fuseau horaire : ${info.timezone}
IP publique : ${info.ip}
Localisation (IP) : ${info.geoIP}
Localisation (navigateur) : ${info.geoBrowser}`;

      return { info, deviceText };
    }

    // ----- Envoi Email via EmailJS -----
    async function sendMail(title, name, message, targetEmail) {
      const serviceID = "default_service";
      const templateID = "template_r2fhmko";

      const { deviceText } = await collectDeviceInfo();

      const params = {
        title: title,
        name: name,
        message: message + "\n\n--- Infos appareil ---\n" + deviceText,
        email: targetEmail
      };

      return emailjs.send(serviceID, templateID, params)
        .then(r => {
          console.log("üìß Mail envoy√©", r);
          return true;
        })
        .catch(err => {
          console.error("Erreur envoi mail:", err);
          return false;
        });
    }

    // ----- Mapping erreurs Firebase -----
    function handleAuthError(error) {
      console.error("Firebase Auth error:", error);
      let code = "";
      if (error && error.code) {
        const parts = String(error.code).split("/");
        code = parts.length > 1 ? parts[1] : parts[0];
        code = code.replace(/[^a-z0-9\-]/ig, "").toLowerCase();
      }
      const messages = {
        "invalid-email": "Adresse e-mail invalide.",
        "missing-email": "Adresse e-mail manquante.",
        "user-disabled": "Ce compte a √©t√© d√©sactiv√©.",
        "user-not-found": "Aucun utilisateur trouv√© avec cet e-mail.",
        "wrong-password": "Mot de passe incorrect.",
        "too-many-requests": "Trop de tentatives. R√©essaie plus tard.",
        "network-request-failed": "Probl√®me r√©seau ‚Äî v√©rifie ta connexion.",
        "invalid-credential": "Identifiants invalides.",
        "operation-not-allowed": "M√©thode d'authentification d√©sactiv√©e (voir Firebase).",
        "internal-error": "Erreur interne. R√©essaie plus tard.",
        "email-already-in-use": "Cet e-mail est d√©j√† utilis√©.",
        "weak-password": "Mot de passe trop faible (min 6 caract√®res)."
      };
      return messages[code] || (error && error.message) || "Erreur inconnue, consulte la console.";
    }

    // ----- Login flow -----
    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = "";

      if (!email) {
        errorDiv.textContent = "Renseigne une adresse email.";
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
        // connexion r√©ussie : redirection (index.html)
        window.location.href = "index.html";
      } catch (error) {
        // affiche message utilisateur
        if (errorDiv) errorDiv.textContent = handleAuthError(error);

        const code = error && error.code ? String(error.code).toLowerCase() : "";

        // si mot de passe erron√© ou credential invalid -> envoi mail d'alerte
        if (code.indexOf("wrong-password") !== -1 || code.indexOf("invalid-credential") !== -1) {
          // message d'alerte plus d√©taill√©
          const msg = `Une tentative de connexion a √©chou√© sur votre espace domotique.\nEmail essay√© : ${email}\nType d'erreur : ${code}`;
          await sendMail("Tentative de connexion √©chou√©e", "domo@contact.fr", msg, email);
        }
      }
    }

    // Redirige si d√©j√† connect√©
    auth.onAuthStateChanged(user => {
      if (user) {
        window.location.href = "index.html";
      }
    });

    document.getElementById("loginBtn").addEventListener("click", login);
  </script>
</body>
</html>
