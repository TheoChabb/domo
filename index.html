<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Accueil</title>
  <link rel="stylesheet" href="styles/style2.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <h1>Bienvenue sur votre site s√©curis√© !</h1>
  <p id="user-info"></p>
  <button id="logoutBtn">Se d√©connecter</button>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init('TsfbNCBs576Ka422a'); // cl√© publique EmailJS
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    // ----- Config Firebase -----
    const firebaseConfig = {
      apiKey: "AIzaSyC9npt7PuRmlNUcPSFQbhQL5lkT3rejNKQ",
      authDomain: "securisation-domotique.firebaseapp.com",
      projectId: "securisation-domotique",
      storageBucket: "securisation-domotique.appspot.com",
      messagingSenderId: "493865233555",
      appId: "1:493865233555:web:25f2adb612c3b98da9b166",
      measurementId: "G-F4KHR48KZR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ----- Helpers r√©utilisables (IP, geoIP, navigateur) -----
    async function getPublicIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip || "IP inconnue";
      } catch (e) {
        return "IP inconnue";
      }
    }

    async function getGeoFromIP(ip) {
      try {
        const res = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await res.json();
        if (data && !data.error) {
          const city = data.city || "‚Äî";
          const region = data.region || "‚Äî";
          const country = data.country_name || "‚Äî";
          return `${city}, ${region}, ${country}`;
        }
        return "Localisation IP inconnue";
      } catch (e) {
        return "Localisation IP inconnue";
      }
    }

    function getBrowserLocation(timeoutMs = 8000) {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve("GPS non disponible");
          return;
        }
        let handled = false;
        const timer = setTimeout(() => {
          if (!handled) {
            handled = true;
            resolve("Permission GPS expir√©e ou lente");
          }
        }, timeoutMs);

        navigator.geolocation.getCurrentPosition(
          pos => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            resolve(`GPS: ${pos.coords.latitude}, ${pos.coords.longitude} (pr√©cision ${pos.coords.accuracy}m)`);
          },
          () => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            resolve("Permission GPS refus√©e ou erreur");
          },
          { enableHighAccuracy: false, maximumAge: 60_000, timeout: timeoutMs }
        );
      });
    }

    async function collectDeviceInfo() {
      const ip = await getPublicIP();
      const geoIP = await getGeoFromIP(ip);
      const geoBrowser = await getBrowserLocation();
      const deviceText = 
`Navigateur/OS : ${navigator.userAgent || "‚Äî"}
Plateforme : ${navigator.platform || "‚Äî"}
Langue : ${navigator.language || "‚Äî"}
R√©solution √©cran : ${screen.width}x${screen.height}
Fuseau horaire : ${Intl.DateTimeFormat().resolvedOptions().timeZone || "‚Äî"}
IP publique : ${ip}
Localisation (IP) : ${geoIP}
Localisation (navigateur) : ${geoBrowser}`;
      return deviceText;
    }

    async function sendMail(title, name, message, targetEmail) {
      const serviceID = "default_service";
      const templateID = "template_r2fhmko";
      const deviceText = await collectDeviceInfo();
      const params = {
        title,
        name,
        message: message + "\n\n--- Infos appareil ---\n" + deviceText,
        email: targetEmail
      };
      return emailjs.send(serviceID, templateID, params)
        .then(r => { console.log("üìß Mail envoy√©", r); return true; })
        .catch(err => { console.error("Erreur envoi mail:", err); return false; });
    }

    // ----- Auth state -----
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // pas connect√© -> renvoyer login
        window.location.href = "login.html";
        return;
      }
      // connect√©
      document.getElementById("user-info").innerText = "Connect√© en tant que : " + user.email;

      // Envoi d'un mail automatique pour nouvelle connexion
      const message = `Nouvelle connexion r√©ussie sur votre espace domotique.\nCompte : ${user.email}\nHeure : ${new Date().toLocaleString()}`;
      await sendMail("Nouvelle connexion !", "domo@contact.fr", message, user.email);
    });

    // ----- Logout (envoie alerte si souhait√©) -----
    async function logout() {
      const user = auth.currentUser;
      if (user) {
        // mail d'alerte sur d√©connexion volontaire (optionnel)
        const msg = `D√©connexion effectu√©e pour le compte : ${user.email}\nHeure : ${new Date().toLocaleString()}`;
        // on envoie mais on n'attend pas pour ne pas bloquer l'UX
        sendMail("D√©connexion", "domo@contact.fr", msg, user.email).catch(()=>{});
      }

      auth.signOut()
        .then(() => {
          window.location.href = "login.html";
        })
        .catch(error => {
          alert("Erreur : " + error.message);
        });
    }

    document.getElementById("logoutBtn").addEventListener("click", logout);
  </script>
</body>
</html>
