<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Domotique - </title>
  <link rel="stylesheet" href="styles/style2.css">
  <link rel="stylesheet" href="styles/style3.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="scripts/script4.js" defer></script>
</head>
<body>
  <div class="menu" id="menu">
        <ul>
            <li><button onclick="changeSection(0)">Accueil</button></li>
            <li><button onclick="changeSection(1)">Domotique</button></li>
            <li><button onclick="changeSection(2)">Music</button></li>
            <li><button onclick="changeSection(3)">Param&egrave;tres</button></li>
        </ul>
        <div id="dateTel" class="dateTel"></div>
    </div>
    <header>
        <div id="date" class="date"></div>
        <h1>Domotique</h1>
        <a onclick="toggleMenu()"><img class="imgMenu" src="images/imgMenu.png"></a>
    </header>


    
    <div class="page" id="page">
        <div class="section accueil">
            <br>
            <div class="widjet">
                <h1>Statuts lampes :</h1>
                <p> Lampe chambre : <span id="lampeChambre">Chargement...</span><br>
                    Lampe bureau : <span id="lampeBureau">Chargement...</span><br>
                </p>
            </div>
            
            <div class="widjet">
                <h1>Temp&eacute;rature int&eacute;rieure :</h1>
                <p> Temp&eacute;rature : <span id="tempInt">Chargement...</span>Â°C<br>
                    Humidit&eacute; : <span id="humiInt">Chargement...</span>%<br>
                </p>
            </div>
            
            <div class="widjet">
                <h1>Temp&eacute;rature ext&eacute;rieure :</h1>
                <p> Temp&eacute;rature : <span id="tempExt">Chargement...</span>Â°C<br>
                    Humidit&eacute; : <span id="humiExt">Chargement...</span>%<br>
                </p>
            </div>
            
            <div class="widjet">
                <h1>Alarme :</h1>
                <p>Alarme : <span id="alarme">Chargement...</span>
                </p>
            </div>
        </div>
        <div class="section domotique">
            <br>
            <div class="widjet">
                <h1>Allumer/eteindre la lampe du bureau :</h1>
                <button class="wid_button" onclick="updateStatus('bureau', 'ON')">Allumer</button>
                <button class="wid_button" onclick="updateStatus('bureau', 'OFF')">Eteindre</button>
            </div>
            
            <div class="widjet">
                <h1>Allumer/eteindre la lampe de la chambre :</h1>
                <button class="wid_button" onclick="updateStatus('chambre', 'ON')">Allumer</button>
                <button class="wid_button" onclick="updateStatus('chambre', 'OFF')">Eteindre</button>
            </div>
            
            <div class="widjet">
                <h1>Allumer/&eacute;teindre l'alarme :</h1>
                <button class="wid_button" onclick="updateAlarme('ON')">Allumer</button>
                <button class="wid_button" onclick="updateAlarme('OFF')">Eteindre</button>
            </div>
        </div>
        <div class="section music" style="display: flex; flex-wrap: wrap;">
            <br>
            <div class="widjet" style="width: 310px; display: flex; padding: 10px 10px; position: relative;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTveYFxButEl7D36QS4m84oKZnU4Hu9mYamXQ&s  " height="300px">
            </div>
            
            <div class="widjet" style="width: 310px; display: flex; padding: 10px 10px; position: relative;">
                <img src="https://yt3.googleusercontent.com/s_5PfxJQU8Xvzedu_NlV-lBnpasJ0vl9BOXKH9G3EtMspPRQg5YMWz_rJIW5d9aVPBYQk3OTKQ=s900-c-k-c0x00ffffff-no-rj" height="300px">
            </div>
            
            <div class="widjet" style="width: 310px; display: flex; padding: 10px 10px; position: relative;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSIueNJV_vfKhoTu9uThPUOJd_rtL1c0K3iMA&s" height="300px">
            </div>
            
            <div class="widjet" style="width: 310px; display: flex; padding: 10px 10px; position: relative;">
                <img src="https://images.lesindesradios.fr/fit-in/1100x2000/filters:format(webp)/radios/voltage/importrk/news/original/5af2eb14ca3c74.34604632.jpg" height="300px">
            </div>
            
            <div class="widjet" style="width: 310px; display: flex; padding: 10px 10px; position: relative;">
                    <img src="https://i0.wp.com/mbote.cd/app/uploads/2022/11/146E64E2-84D6-4DE5-8646-947C938EBE37.jpeg?fit=554%2C554&ssl=1" height="300px">
            </div>
        </div>
        <div class="section parametres">
            <br>
            <div class="widjet">
                <h1>Modifier l'heure du r&eacute;veil :</h1>
                <input type="time" id="heureInput">
                <button onclick="validerHeure()">Valider</button>
            </div>
            <div class="widjet">
                <h1>Changer de style :</h1>
                <ul>
                    <li><button onclick="changerStyle('#e7e7e7', '#0091d4', '#fff', '#007db8', '#0091d4', '#fff', '#e7e7e7', '#fff')">Changer de Style en bleu</button></li>
                    <li><button onclick="changerStyle('#e7e7e7', '#00d471', '#fff', '#05b160', '#00d471', '#fff', '#e7e7e7', '#fff')">Changer de Style vert</button></li>
                    <li><button onclick="changerStyle('#e7e7e7', '#d40000', '#fff', '#b80000', '#d40000', '#fff', '#e7e7e7', '#fff')">Changer de Style rouge</button></li>
                    <li><button onclick="changerStyle('#e7e7e7', '#35424a', '#fff', '#5f6f79', '#35424a', '#fff', '#e7e7e7', '#fff')">Changer de Style gris</button></li>
                </ul>
            </div>
            <div class="widjet">
                <h1>Mettre/enlever le mode sombre :</h1>
                <button onclick="changerStyle('#121212', '#003c5d', '#fff', '#004c7d', '#00b0f0', '#333', '#474747', '#fff')">Acctiver</button>
                <button onclick="changerStyle('#e7e7e7', '#0091d4', '#fff', '#007db8', '#0091d4', '#fff', '#e7e7e7', '#fff')">Enlever</button>
            </div>
            <div class="widjet">
                <button id="logoutBtn">Se dÃ©connecter</button>
            </div>
        </div>
    </div>

  




  

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init('TsfbNCBs576Ka422a'); // clÃ© publique EmailJS
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    // ----- Config Firebase -----
    const firebaseConfig = {
      apiKey: "AIzaSyC9npt7PuRmlNUcPSFQbhQL5lkT3rejNKQ",
      authDomain: "securisation-domotique.firebaseapp.com",
      projectId: "securisation-domotique",
      storageBucket: "securisation-domotique.appspot.com",
      messagingSenderId: "493865233555",
      appId: "1:493865233555:web:25f2adb612c3b98da9b166",
      measurementId: "G-F4KHR48KZR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ----- Helpers rÃ©utilisables (IP, geoIP, navigateur) -----
    async function getPublicIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip || "IP inconnue";
      } catch (e) {
        return "IP inconnue";
      }
    }

    async function getGeoFromIP(ip) {
      try {
        const res = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await res.json();
        if (data && !data.error) {
          const city = data.city || "â€”";
          const region = data.region || "â€”";
          const country = data.country_name || "â€”";
          return `${city}, ${region}, ${country}`;
        }
        return "Localisation IP inconnue";
      } catch (e) {
        return "Localisation IP inconnue";
      }
    }

    function getBrowserLocation(timeoutMs = 8000) {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve("GPS non disponible");
          return;
        }
        let handled = false;
        const timer = setTimeout(() => {
          if (!handled) {
            handled = true;
            resolve("Permission GPS expirÃ©e ou lente");
          }
        }, timeoutMs);

        navigator.geolocation.getCurrentPosition(
          pos => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            resolve(`GPS: ${pos.coords.latitude}, ${pos.coords.longitude} (prÃ©cision ${pos.coords.accuracy}m)`);
          },
          () => {
            if (handled) return;
            handled = true;
            clearTimeout(timer);
            resolve("Permission GPS refusÃ©e ou erreur");
          },
          { enableHighAccuracy: false, maximumAge: 60_000, timeout: timeoutMs }
        );
      });
    }

    async function collectDeviceInfo() {
      const ip = await getPublicIP();
      const geoIP = await getGeoFromIP(ip);
      const geoBrowser = await getBrowserLocation();
      const deviceText = 
`Navigateur/OS : ${navigator.userAgent || "â€”"}
Plateforme : ${navigator.platform || "â€”"}
Langue : ${navigator.language || "â€”"}
RÃ©solution Ã©cran : ${screen.width}x${screen.height}
Fuseau horaire : ${Intl.DateTimeFormat().resolvedOptions().timeZone || "â€”"}
IP publique : ${ip}
Localisation (IP) : ${geoIP}
Localisation (navigateur) : ${geoBrowser}`;
      return deviceText;
    }

    async function sendMail(title, name, message, targetEmail) {
      const serviceID = "default_service";
      const templateID = "template_r2fhmko";
      const deviceText = await collectDeviceInfo();
      const params = {
        title,
        name,
        message: message + "\n\n--- Infos appareil ---\n" + deviceText,
        email: targetEmail
      };
      return emailjs.send(serviceID, templateID, params)
        .then(r => { console.log("ðŸ“§ Mail envoyÃ©", r); return true; })
        .catch(err => { console.error("Erreur envoi mail:", err); return false; });
    }

    // ----- Auth state -----
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // pas connectÃ© -> renvoyer login
        window.location.href = "login.html";
        return;
      }
      // connectÃ©
      document.getElementById("user-info").innerText = "ConnectÃ© en tant que : " + user.email;

      // Envoi d'un mail automatique pour nouvelle connexion
      const message = `Nouvelle connexion rÃ©ussie sur votre espace domotique.\nCompte : ${user.email}\nHeure : ${new Date().toLocaleString()}`;
      await sendMail("Nouvelle connexion !", "domo@contact.fr", message, user.email);
    });

    // ----- Logout (envoie alerte si souhaitÃ©) -----
    async function logout() {
      const user = auth.currentUser;
      if (user) {
        // mail d'alerte sur dÃ©connexion volontaire (optionnel)
        const msg = `DÃ©connexion effectuÃ©e pour le compte : ${user.email}\nHeure : ${new Date().toLocaleString()}`;
        // on envoie mais on n'attend pas pour ne pas bloquer l'UX
        sendMail("DÃ©connexion", "domo@contact.fr", msg, user.email).catch(()=>{});
      }

      auth.signOut()
        .then(() => {
          window.location.href = "login.html";
        })
        .catch(error => {
          alert("Erreur : " + error.message);
        });
    }

    document.getElementById("logoutBtn").addEventListener("click", logout);
  </script>
</body>
</html>
